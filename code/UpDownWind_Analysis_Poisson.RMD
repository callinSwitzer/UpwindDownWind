---
output: html_document
editor_options: 
  chunk_output_type: console
---
## Callin Switzer
## Initial Code: 20 Sept 2017
## Analysis of upwind / downwind data
## Update: 2 March 2019
##

---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r, warning = FALSE, message=FALSE}
#install packages
ipak <- function(pkg){
     new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
     if(length(new.pkg)) install.packages(new.pkg, dependencies = TRUE)
     sapply(pkg, require, character.only = TRUE)
}

packages <- c("tidyverse", "lubridate")
ipak(packages)

# set ggplot theme
theme_set(theme_classic() + 
            theme(axis.text=element_text(colour="black"), 
                  text=element_text(size=10)))

# set  directories
dataDir <- file.path(getwd(), "data")
figDir <- file.path(getwd(), "figures")
dataOut <- file.path(getwd(), "dataOutput")

print(paste("last run ", Sys.time()))
print(R.version)
```

# Import

```{r, message = FALSE}
updn <- read_csv(file.path(dataDir, "Data2D_UpwindDownwind.csv"))
```


# Tidy and Transform data
```{r}

titleCase = function(vect){
  gsub("(^|[[:space:]])([[:alpha:]])", 
       "\\1\\U\\2", tolower(vect), perl=TRUE)
}

updn <- updn %>%
  # rename columns to replace punctuation with "_"
  rename_all(list(~gsub('[[:punct:] ]+','_',colnames(updn)))) %>%
  # remove single quote from strings
  mutate_all(list(~gsub("\'", "", .))) %>%
  # convert to datetime
  mutate(datetime = as_date(.$day, format = "%m_%d_%y", tz = "UTC"), 
  # convert to numeric
         minute = as.numeric(.$minute),
         flow_category = as.numeric(.$flow_category)) %>%
  # change factors
  
  mutate(side = titleCase(.$side), 
         flight_direction = recode(.$flight_direction, 
                                   "FEED" = "Towards feeder", 
                                   "NEST" = "Towards colony"), 
         fast_slow = titleCase(.$fast_slow),
         bee_wind_orientation = recode(bee_wind_orientation, 
                                       "DW" = "Downwind", 
                                       "UW" = "Upwind", 
                                       "NW" = "No wind"), 
         side = recode(side, "Rite" = "Right")) %>%
  mutate(trt_interaction = interaction(bee_wind_orientation, 
                              fast_slow,  
                              flight_direction))

tb <- table(updn$trt_interaction)
# order by count
updn$trt <-  factor(updn$trt_interaction,
                    levels = names(tb[order(tb, decreasing = TRUE)]))

updn

```


# Visualize


```{r}
aa <- ggplot(updn, aes(x = flight_direction, fill  = bee_wind_orientation)) + 
  geom_bar(alpha = 0.7) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + 
  geom_hline(aes(yintercept =  0.5)) + 
  scale_fill_viridis_d() 

aa#+ facet_wrap(~day)


aa <- ggplot(updn, aes(fill = flight_direction, x  = bee_wind_orientation)) + 
  geom_bar(position = "fill", alpha = 0.7) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + 
  geom_hline(aes(yintercept =  0.5)) + 
  scale_fill_viridis_d() + 
  labs(y = "proportion")

aa#+ facet_wrap(~day)

```

```{r, results = "hide", fig.show = "hide"}
# Is there "conservation of bee"?
# do the same number of bees go out as go in?
ggplot(updn, aes(x = flight_direction, fill = bee_wind_orientation)) + 
  geom_bar() + 
  #facet_wrap(.~ day) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


table(updn$flight_direction)
prop.test(1891, 1891 + 1561)


# plot counts
ggplot(updn, aes(x = interaction(side, fast_slow, flight_direction), fill = bee_wind_orientation)) + 
  geom_bar() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(updn, aes(x = interaction(side, fast_slow, flight_direction), fill = bee_wind_orientation)) + 
  geom_bar() + 
  facet_wrap(~day) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# this is the cause of "Simpson's paradox"
ggplot(updn, aes(x = interaction(flight_direction, side), fill = bee_wind_orientation)) + 
  geom_bar() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(updn[updn$bee_wind_orientation != "No wind",], aes(x = interaction(flight_direction, side), fill = bee_wind_orientation)) + 
  geom_bar() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


ggplot(updn[updn$bee_wind_orientation != "No wind",], 
       aes(x = side, 
        fill = bee_wind_orientation)) + 
  geom_bar() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


ggplot(updn[updn$bee_wind_orientation != "No wind",], 
       aes(x = interaction(flight_direction, side, fast_slow), 
           fill = bee_wind_orientation)) + 
  geom_bar() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


# plot proportions
aa <- ggplot(updn, aes(x = interaction(side, fast_slow, flight_direction), fill = bee_wind_orientation)) + 
  geom_bar(position = "fill") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  geom_hline(aes(yintercept =  0.5))
aa


bb <- ggplot(updn, aes(x = trt, fill  = bee_wind_orientation)) + 
  geom_bar(position = "identity", alpha = 0.5) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + 
  geom_hline(aes(yintercept =  0.5)) + 
  scale_fill_viridis_d()
bb

bb + facet_wrap(~day)


# find the maximum number of minutes per day
tapply(updn$minute, INDEX = updn$day, max)

# find the sample sizes for each day
xtabs(~updn$day) # looks like some days were quite small -- like 6/12/17

# find unique experiments, in case we want to analyze separately
trts <- as.data.frame((tapply(as.character(updn$trt),
                              updn$day, 
                              FUN = function(x) paste(sort(unique(x)) , collapse = " " ))))
trts$date = row.names(trts)
colnames(trts) = c("experiment", "date")
trts
unique(trts$experiment)

# label experiments in dataset
updn$experiment <- plyr::mapvalues(updn$day, from = trts$date, to = trts$experiment) %>% as.factor()

# visualize different experiments

cc <- ggplot(updn, aes(x = trt, fill = bee_wind_orientation)) + 
  geom_bar(position = "identity", alpha = 0.5) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + 
  geom_hline(aes(yintercept =  0.5)) + 
  scale_fill_viridis_d() + 
  facet_grid(experiment ~ side  + flight_direction)
cc

```

## Model

# refref: we need to know velocity, in order to come up with a null hypothesis
# what if velocity is not constant throughout trial? Do we need instantaneous velocity?


```{r}

#________________________________________________________________________ 
# Analysis for exp 1
#________________________________________________________________________ 

exp1 <- updn[updn$experiment == levels(updn$experiment)[1], ] %>% droplevels()
summary(exp1)

colnames(exp1)


bb <- ggplot(exp1, aes(x = flight_direction, fill  = bee_wind_orientation)) + 
  geom_bar(alpha = 0.7) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + 
  geom_hline(aes(yintercept =  0.5)) + 
  scale_fill_viridis_d() 

bb #+ facet_wrap(~day)

# conservation of bee?
table(exp1$flight_direction)
prop.test(618, 1174, correct = TRUE)

```


```{r, eval = FALSE}
bb <- ggplot(exp1, aes(x = flight_direction, fill  = bee_wind_orientation)) + 
  geom_bar(alpha = 0.5) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + 
   scale_fill_viridis_d() 
bb


bb + facet_wrap(~day)



#Simpson's paradox
# plot #1 (slices data differently than below)
ggplot(exp1, aes(x = flight_direction)) + 
  geom_bar(alpha = 0.5, aes(fill = bee_wind_orientation)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + 
  scale_fill_viridis_d() + 
  facet_grid(~side, labeller = labeller(.rows = label_both, .cols = label_both))+
  labs(y = "Count of flights")

# if you look at each day, then the trend seems to be reversed in some cases
ggplot(exp1, aes(x = flight_direction)) + 
  geom_bar(alpha = 0.5, aes(fill = bee_wind_orientation)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + 
  scale_fill_viridis_d() + 
  facet_grid(day~side, labeller = labeller(.rows = label_both, .cols = label_both))+
  labs(y = "Count of flights")

ggplot(exp1, aes(x = flight_direction)) + 
  geom_bar(alpha = 0.5, aes(fill = bee_wind_orientation)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + 
  scale_fill_viridis_d() + 
  facet_grid(~day, labeller = labeller(.rows = label_both, .cols = label_both))+
  labs(y = "Count of flights")



cc <- ggplot(exp1, aes(x = side, fill = bee_wind_orientation)) + 
  geom_bar(position = "fill", alpha = 0.5) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + 
  geom_hline(aes(yintercept =  0.5), linetype = 2) + 
  scale_fill_viridis_d() + 
  facet_grid( flight_direction ~  fast_slow, labeller = labeller(.rows = label_both, .cols = label_both))
cc





# # visualize speed of bees in two conditions
# ggplot(exp1, aes(x = fast_slow, y = abs(y.velocity.avg), fill = day)) +
#   facet_grid(side ~ flight_direction) + 
#   geom_boxplot() + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))
# 
# ggplot(exp1, aes(x = bee_wind_orientation, y = abs(y.velocity.avg), fill = day)) +
#   geom_boxplot() + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))
# 
# ggplot(updn, aes(x = bee_wind_orientation, y = abs(y.velocity.avg))) +
#   geom_boxplot() + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
# 
# ggplot(updn, aes(x = day, y = abs(y.velocity.avg), fill = (bee_wind_orientation))) +
#   geom_boxplot() + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
# 
# 
# ggplot(updn, aes(x = day, y = abs(y.velocity.avg), fill = (bee_wind_orientation))) +
#   geom_boxplot() + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
# 
# modVel <- lm((abs(y.velocity.avg)) ~ bee_wind_orientation, data = updn)
# summary(modVel)
# 
# par(mfrow = c(2,3))
# plot(modVel, which = 1:6)

# refref: do a thought-experiment / simulation to see, what if it was only one bee going in circles?

```

# GLM for experiment 1

### Wind is constant (fast)

```{r}
# glm for experiment 1
exp1$fly_upwind <- plyr::mapvalues(exp1$bee_wind_orientation, 
                                   from = c("Downwind", "No wind", "Upwind"), 
                                           to = c(0, 999, 1)) %>% as.factor()

exp1$fly_upwind <- droplevels(exp1$fly_upwind)
# should be only two options
table(exp1$fly_upwind)


# we must remove either day of side, otherwise we get NA's
# day and side are completely confounding

# this data frame has NAs
exp1_1 <- exp1 %>%
  select(day, bee_wind_orientation, side, flight_direction) %>%
  group_by(flight_direction, bee_wind_orientation, day, side) %>%
  summarize( n = n()) %>%
  spread(key = bee_wind_orientation, value = n) %>%
  arrange(day)

exp1_1

# in this data frame, I've removed side
ex1 <- exp1 %>%
  select(day, bee_wind_orientation, flight_direction) %>%
  group_by(flight_direction, bee_wind_orientation, day) %>%
  summarize( n = n()) %>%
  spread(key = bee_wind_orientation, value = n) %>%
  arrange(day)
ex1


# note that bees are more likely to fly towards the colony, 
# but they are more likely to fly upwind towards the feeder than upwind towards the colony
exp1 %>%
  select( bee_wind_orientation, flight_direction) %>%
  group_by(flight_direction, bee_wind_orientation) %>%
  summarize( n = n()) %>%
  spread(key = bee_wind_orientation, value = n)

# could switch to sum contrasts -- might make model more interpretable
# options(contrasts=c('contr.sum','contr.poly'))
options(contrasts=c('contr.treatment','contr.poly'))

m1 <- glm(cbind(Upwind, Downwind)  ~ day * flight_direction, data = ex1, family = "binomial")
summary(m1)
drop1(m1, test = "LRT")



# visualize results
# calculate confidence intervals for predictions
preddf <- exp1[, c("side", "flight_direction", "fast_slow", "day", "bee_wind_orientation")]
preddf <- expand.grid(side = unique(exp1$side), 
                      flight_direction = unique(exp1$flight_direction), 
                      day = unique(exp1$day),
                      bee_wind_orientation = unique(exp1$bee_wind_orientation))

pdns <- data.frame(predict(m1, newdata = preddf, type = "link", se.fit = TRUE))
pdns$fit_prob = plogis(pdns$fit)
pdns$lower <- plogis(pdns$fit - 1.96* pdns$se.fit)
pdns$higher <- plogis(pdns$fit + 1.96* pdns$se.fit)

pdns <- data.frame(predict(m1, newdata = preddf, type = "link", se.fit = TRUE))
pdns$fit_prob = plogis(pdns$fit)
pdns$lower <- plogis(pdns$fit - 1.96* pdns$se.fit)
pdns$higher <- plogis(pdns$fit + 1.96* pdns$se.fit)

preddf <- cbind(preddf, pdns)

preddf$`Flight direction` = preddf$flight_direction


ab <- ggplot(preddf, aes(x = day)) + 
  facet_grid(. ~ `Flight direction`, label = "label_both") + 
  scale_y_continuous( limits = c(0,1), expand = c(0,0) ) + 
  labs(y = 'Predicted probability of flying upwind', x = "Day") + 
  geom_errorbar(aes(ymin = lower, ymax = higher), color = "black",  width = 0.1) + 
  geom_hline(aes(yintercept = 0.5), linetype = 2, color = 'grey') + 
 geom_point(aes(y = fit_prob))
ab 


# save plot
ggsave(filename = file.path(figDir, "exp1.png"), plot = ab, width = 8, height = 6, dpi = 250)

```


```{r, eval = F, echo = FALSE}
# Poisson Version 


# # calculate averages from dataset
# poisDF <- as.data.frame(xtabs(~bee_wind_orientation + flight_direction + day +  side, droplevels(exp1)))
# poisDF
# 
# 
# # refref: there is a problem that some treatments are 0 on some days
# ggplot(poisDF, aes(fill = bee_wind_orientation, y = Freq, x = interaction(bee_wind_orientation, side, flight_direction))) + 
#          geom_bar(stat = "identity") + 
#   facet_grid(.~day) + 
#   theme(axis.text.x = element_text(angle = 90, hjust = 0.5))
# 
# 
# daySums <- as.data.frame(tapply(poisDF$Freq, INDEX = list(poisDF$day, poisDF$side), sum))
# daySums$day <- row.names(daySums)
#   
# daySums_l <- as.data.frame(gather(data = daySums, key = "side", value = "day_side_total", -day))
# daySums_l
# 
# 
# posdf2 <- merge(poisDF, daySums_l, by.x = c("day", "side"), by.y = c("day", "side"))
# posdf2
# 
# 
# 
# posdf2$dayPercents <- posdf2$Freq / posdf2$day_side_total
# 
# posdf2 <- posdf2[posdf2$Freq > 0, ]
#   
#   
# m1.1 <- glm(Freq ~ (bee_wind_orientation + flight_direction + day )^2 + offset(log(day_side_total)), data = posdf2, family = poisson("log"))
# summary(m1.1)
# 
# car::vif(m1.1) # kind of high vif
# 
# drop1(m1.1, test = 'LRT')
# 
# m1.2 <- update(m1.1, .~. - flight_direction:day)
# summary(m1.2)
# drop1(m1.2, test = 'LRT')
# 
# m1.3 <- update(m1.2, .~. - bee_wind_orientation:day)
# summary(m1.3)
# drop1(m1.3, test = 'LRT')
# 
# m1.4 <- update(m1.3, .~. - bee_wind_orientation:flight_direction)
# summary(m1.4)
# drop1(m1.4, test = 'LRT')
# 
# m1.5 <- update(m1.4, .~. - day)
# summary(m1.5)
# drop1(m1.5, test = 'LRT')
# 
# finMod = m1.5
# summary(finMod) # weird that bees are more likely to fly away from feeder
# 
# 
# preddf2 <- posdf2
# preddf2$day_side_total <- 1
# 
# confint(finMod)
# 
# pds <- predict(finMod,newdata = preddf2, type = "link", se.fit = TRUE)
# 
# posdf2$predds <- exp(pds$fit)
# posdf2$lower <- exp(pds$fit - 1.96*pds$se.fit)
# posdf2$higher <- exp(pds$fit + 1.96*pds$se.fit)
# 
# 
# 
# # make dataset for figure
# pp1 <- gather(posdf2, key="dataType", value = "proportion", dayPercents:predds) %>%
#   mutate(dataType = recode(dataType, "dayPercents" = "Actual", 
#                            predds = "Predicted mean"))
# 
# # figure for paper
# # plot actual data and predictions
# e1Plot <- ggplot(pp1, aes(x = bee_wind_orientation, y = proportion, color = dataType))+ 
#   facet_grid(.~flight_direction ) + 
#   geom_errorbar(aes(ymin = lower, ymax = higher), width = 0.1, color = 'grey') + 
#   geom_hline(aes(yintercept = 0.5), linetype = 2) + 
#   #geom_point(aes(y = predds), color = 'grey') + 
#   theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + 
#   labs(y = "Proportion of flights", x = "Flight direction") + 
#   geom_point(aes(color = dataType, shape = dataType)) + 
#   scale_color_viridis_d(name = "", begin = 0, end = .8) + 
#   scale_shape_manual(name = "", values = c(16,17))
# e1Plot
# ggsave(e1Plot, filename = file.path(figDir, "exp1.png"), width = 5, height = 7)
# 
# 
# # plot actual data vs. predictions (again)
# set.seed(123)
# ggplot(posdf2, aes(x = bee_wind_orientation, y = dayPercents))+ 
#   geom_point(position = position_jitter(width = 0.03), alpha = 0.2) + 
#   geom_errorbar(aes(ymin = lower, ymax = higher), width = 0.05, color = 'black') + 
#   geom_hline(aes(yintercept = 0.5), linetype = 2) + 
#   geom_point(aes(y = predds), color = 'black') + 
#   labs(x = "bee wind orientation", y = "probability of flight") +
#   ylim(c(0,1)) + 
#   ggtitle("Flight probablility for experiment 1 (fast both sides)")
# 
# 
```


# Experiment 2

# variable windspeed

```{r}

#________________________________________________________________________ 
# Experiment 2
# this incorporates, fast/slow, left/right/ and box/nectar
#________________________________________________________________________ 



exp2 <- updn[updn$experiment %in% levels(updn$experiment)[2:3], ] %>% as.tbl()
exp2
colnames(exp2)

exp2$fly_upwind <- plyr::mapvalues(exp2$bee_wind_orientation, 
                                   from = c("Downwind", "No wind", "Upwind"), 
                                           to = c(0, 999, 1)) %>% as.factor()

exp2$fly_upwind <- droplevels(exp2$fly_upwind)

# should be only two options
table(exp2$fly_upwind)



# there is complete confounding -- we must drop two variables
# this data frame has NAs
exp2_1 <- exp2 %>%
  select(day, bee_wind_orientation, side, flight_direction,fast_slow ) %>%
  group_by(flight_direction, bee_wind_orientation, day, side, fast_slow) %>%
  summarize( n = n()) %>%
  spread(key = bee_wind_orientation, value = n) %>%
  arrange(day)

exp2_1

# in this data frame, I've removed side, but there is still confounding
exp2_2 <- exp2 %>%
  select(day, bee_wind_orientation, flight_direction, fast_slow) %>%
  group_by(flight_direction, bee_wind_orientation, day, fast_slow) %>%
  summarize( n = n()) %>%
  spread(key = bee_wind_orientation, value = n) %>%
  arrange(day)
exp2_2



# in this data frame, I've removed side and day
exp2_3 <- exp2 %>%
  select( bee_wind_orientation, flight_direction, fast_slow) %>%
  group_by(flight_direction, bee_wind_orientation, fast_slow) %>%
  summarize( n = n()) %>%
  spread(key = bee_wind_orientation, value = n) 
exp2_3

# exp2_3$upPercent = exp2_3$Upwind / (exp2_3$Upwind + exp2_3$Downwind)



m2.1 <- glm(cbind(Upwind, Downwind)  ~ fast_slow * flight_direction, data = exp2_3, family = "binomial")
summary(m2.1)
drop1(m2.1, test = "LRT")



# visualize results
# calculate confidence intervals for predictions
preddf <- exp2_3[, c("flight_direction", "fast_slow")]
preddf <- expand.grid(flight_direction = unique(exp2_3$flight_direction), 
                      fast_slow = unique(exp2_3$fast_slow))

pdns <- data.frame(predict(m2.1, newdata = preddf, type = "link", se.fit = TRUE))
pdns$fit_prob = plogis(pdns$fit)
pdns$lower <- plogis(pdns$fit - 1.96* pdns$se.fit)
pdns$higher <- plogis(pdns$fit + 1.96* pdns$se.fit)

pdns <- data.frame(predict(m2.1, newdata = preddf, type = "link", se.fit = TRUE))
pdns$fit_prob = plogis(pdns$fit)
pdns$lower <- plogis(pdns$fit - 1.96* pdns$se.fit)
pdns$higher <- plogis(pdns$fit + 1.96* pdns$se.fit)

preddf <- cbind(preddf, pdns)

preddf$`Flight direction` = preddf$flight_direction


ac <- ggplot(preddf, aes(x = fast_slow)) + 
  facet_grid(. ~ `Flight direction`, label = "label_both") + 
  scale_y_continuous( limits = c(0,1), expand = c(0,0) ) + 
  labs(y = 'Predicted probability of flying upwind', x = "Wind Speed") + 
  geom_errorbar(aes(ymin = lower, ymax = higher), color = "black",  width = 0.1) + 
  geom_hline(aes(yintercept = 0.5), linetype = 2, color = 'grey') + 
 geom_point(aes(y = fit_prob))
ac 


# save plot
ggsave(filename = file.path(figDir, "exp2.png"), plot = ac, width = 5, height = 6, dpi = 250)


```

```{r, eval = FALSE, echo = FALSE}
# 
# # calculate averages from dataset
# poisDF3 <- as.data.frame(xtabs(~bee_wind_orientation + flight_direction + day +  side + fast_slow, droplevels(exp2)))
# 
# 
# daySums <- as.data.frame(tapply(poisDF3$Freq, INDEX = list(poisDF3$day, poisDF3$side), sum))
# daySums$day <- row.names(daySums)
# 
# daySums_l <- as.data.frame(gather(data = daySums, key = "side", value = "day_side_total", -day))
# daySums_l
# 
# 
# p3 <- merge(poisDF3, daySums_l, by.x = c("day", "side"), by.y = c("day", "side"))
# p3
# 
# 
# 
# p3$dayPercents <- p3$Freq / p3$day_side_total
# 
# p3 <- p3[p3$Freq > 0, ]
# p3
# 
# m2.1 <- glm(Freq ~ (bee_wind_orientation + flight_direction + side + fast_slow)^2 + offset(log(day_side_total)), data = p3, family = poisson("log"))
# summary(m2.1)
# 
# car::vif(m2.1) # a little high
# 
# drop1(m2.1, test = 'LRT')
# 
# m2.2 <- update(m2.1, .~. - side:fast_slow)
# summary(m2.2)
# drop1(m2.2, test = 'LRT')
# 
# 
# 
# m2.3 <- update(m2.2, .~. - bee_wind_orientation:fast_slow)
# summary(m2.3)
# drop1(m2.3, test = 'LRT')
# 
# m2.4 <- update(m2.3, .~. - bee_wind_orientation:flight_direction)
# summary(m2.4)
# drop1(m2.4, test = 'LRT')
# 
# m2.5 <- update(m2.4, .~. - bee_wind_orientation:side)
# summary(m2.5)
# drop1(m2.5, test = 'LRT')
# 
# 
# m2.6 <- update(m2.5, .~. - flight_direction:side)
# summary(m2.6)
# drop1(m2.6, test = "LRT")
# 
# # final model for paper
# finMod2 <- m2.6
# summary(finMod2)
# 
# 
# preddf2 <- p3
# preddf2$day_side_total <- 1
# 
# 
# 
# pds <- predict(m2.6,newdata = preddf2, type = "link", se.fit = TRUE)
# 
# p3$predds <- exp(pds$fit)
# p3$lower <- exp(pds$fit - 1.96*pds$se.fit)
# p3$higher <- exp(pds$fit + 1.96*pds$se.fit)
# 
# 
# # make dataset for figure
# pp3 <- gather(p3, key="dataType", value = "proportion", dayPercents:predds) %>%
#   mutate(dataType = recode(dataType, "dayPercents" = "Actual", 
#                            predds = "Predicted mean"))
# 
# # figure for paper
# # plot actual data and predictions
# e2Plot <- ggplot(pp3, aes(x = flight_direction, y = proportion, color = dataType))+ 
#   
#   facet_grid(fast_slow~bee_wind_orientation + side) + 
#   geom_errorbar(aes(ymin = lower, ymax = higher), width = 0.1, color = 'grey') + 
#   geom_hline(aes(yintercept = 0.5), linetype = 2) + 
#   #geom_point(aes(y = predds), color = 'grey') + 
#   theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + 
#   labs(y = "Proportion of flights", x = "Flight direction") + 
#   geom_point(aes(color = dataType, shape = dataType)) + 
#   scale_color_viridis_d(name = "", begin = 0, end = .8) + 
#   scale_shape_manual(name = "", values = c(16,17))
# e2Plot
# ggsave(e2Plot, filename = file.path(figDir, "exp2.png"), width = 5, height = 7)
# 
# 
# 
# # plot actual data vs. predictions (again)
# set.seed(123)
# ggplot(p3, aes(x = bee_wind_orientation, y = dayPercents))+ 
#   geom_point(position = position_jitter(width = 0.03), alpha = 0.2) + 
#   geom_errorbar(aes(ymin = lower, ymax = higher), width = 0.05, color = 'black') + 
#   geom_hline(aes(yintercept = 0.5), linetype = 2) + 
#   geom_point(aes(y = predds), color = 'black') + 
#   labs(x = "bee wind orientation", y = "probability of flight") +
#   ylim(c(0,1)) + 
#   ggtitle("Flight probablility for experiment 2 (fast/slow wind)") 

```



```{r}
#________________________________________________________________________ 
# Experiment 3
# Control
#________________________________________________________________________ 


exp3 <- updn[updn$experiment %in% levels(updn$experiment)[4], ]
colnames(exp3)

# there are more bees coming towards the colony
prop.test(table(exp3$flight_direction))

# this plot shows the difference
ggplot(exp3, aes(x = flight_direction, fill = side)) + 
  geom_bar() + 
  facet_wrap(~day)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))




exp_3 <- exp3 %>%
  select(day, side, flight_direction ) %>%
  group_by(flight_direction, day, side) %>%
  summarize( n = n()) %>%
  spread(key = side, value = n) %>%
  arrange(day) %>%
  mutate(rightPercent = Right / (Left + Right))
exp_3


m3.1 <- glm(cbind(Right, Left)  ~ flight_direction * day, data = exp_3, family = "binomial")
summary(m3.1)
drop1(m3.1, test = "LRT")

m3.2 <- update(m3.1, .~. - flight_direction : day)
summary(m3.2)
drop1(m3.2, test = "LRT")

m3.3 <- update(m3.2, .~. - flight_direction)
summary(m3.3)
drop1(m3.3, test = "LRT")

finmod <- m3.3
summary(finmod)



# visualize results
# calculate confidence intervals for predictions
preddf <- exp3[, c("flight_direction", "day")]
preddf <- expand.grid(flight_direction = unique(exp3$flight_direction), 
                      day = unique(exp3$day))

pdns <- data.frame(predict(finmod, newdata = preddf, type = "link", se.fit = TRUE))
pdns$fit_prob = plogis(pdns$fit)
pdns$lower <- plogis(pdns$fit - 1.96* pdns$se.fit)
pdns$higher <- plogis(pdns$fit + 1.96* pdns$se.fit)

pdns <- data.frame(predict(finmod, newdata = preddf, type = "link", se.fit = TRUE))
pdns$fit_prob = plogis(pdns$fit)
pdns$lower <- plogis(pdns$fit - 1.96* pdns$se.fit)
pdns$higher <- plogis(pdns$fit + 1.96* pdns$se.fit)

preddf <- cbind(preddf, pdns)

ad <- ggplot(preddf, aes(x = day)) + 
  scale_y_continuous( limits = c(0,1), expand = c(0,0) ) + 
  labs(y = 'Predicted probability of flying on the right side', x = "Day") + 
  geom_errorbar(aes(ymin = lower, ymax = higher), color = "black",  width = 0.1) + 
  geom_hline(aes(yintercept = 0.5), linetype = 2, color = 'grey') + 
 geom_point(aes(y = fit_prob))
ad 


# save plot
ggsave(filename = file.path(figDir, "exp3_control.png"), plot = ad, width = 4, height = 6, dpi = 250)

```



```{r, eval = FALSE, echo = FALSE}
# # calculate averages from dataset
# poisDF3 <- as.data.frame(xtabs(~bee_wind_orientation + flight_direction + day +  side + fast_slow, droplevels(exp3)))
# 
# 
# daySums <- as.data.frame(tapply(poisDF3$Freq, INDEX = list(poisDF3$day, poisDF3$side), sum))
# daySums$day <- row.names(daySums)
# 
# daySums_l <- as.data.frame(gather(daySums, key = day))
# colnames(daySums_l) <- c("day", "side", "day_side_total")
# 
# 
# p3 <- merge(poisDF3, daySums_l, by.x = c("day", "side"), by.y = c("day", "side"))
# 
# 
# 
# 
# p3$dayPercents <- p3$Freq / p3$day_side_total
# 
# p3 <- p3[p3$Freq > 0, ]
# p3
# 
# m2.1 <- glm(Freq ~ (flight_direction + side)^2 + offset(log(day_side_total)), data = p3, family = poisson("log"))
# summary(m2.1)
# 
# car::vif(lm(Freq ~ (flight_direction + side)^2 + offset(log(day_side_total)), data = p3))
# 
# drop1(m2.1, test = 'LRT')
# 
# m2.2 <- update(m2.1, .~. - flight_direction:side)
# summary(m2.2)
# drop1(m2.2, test = 'LRT')
# 
# 
# 
# m2.3 <- update(m2.2, .~. - side)
# summary(m2.3)
# 
# preddf2 <- p3
# preddf2$day_side_total <- 1
# 
# 
# 
# pds <- predict(m2.3,newdata = preddf2, type = "link", se.fit = TRUE)
# 
# p3$predds <- exp(pds$fit)
# p3$lower <- exp(pds$fit - 1.96*pds$se.fit)
# p3$higher <- exp(pds$fit + 1.96*pds$se.fit)
# p3
# 
# 
# # plot actual data and predictions
# 
# ggplot(p3, aes(x = flight_direction, y = dayPercents))+ 
#   geom_point() + 
#   facet_grid(~day) + 
#   geom_errorbar(aes(ymin = lower, ymax = higher), width = 0.1) + 
#   geom_hline(aes(yintercept = 0.5), linetype = 2) + 
#   geom_point(aes(y = predds), position = position_jitter(width = 0.1, height = 0), color = 'grey')
# 
# 
# # plot actual data vs. predictions (again)
# set.seed(123)
# ggplot(p3, aes(x = flight_direction, y = dayPercents))+ 
#   geom_point(position = position_jitter(width = 0.03), alpha = 0.2) + 
#   geom_errorbar(aes(ymin = lower, ymax = higher), width = 0.05, color = 'black') + 
#   geom_hline(aes(yintercept = 0.5), linetype = 2) + 
#   geom_point(aes(y = predds), color = 'black') + 
#   labs(x = "bee wind orientation", y = "probability of flight") +
#   ylim(c(0,1)) + 
#   ggtitle("Flight probablility for experiment 3 (no wind)")

```